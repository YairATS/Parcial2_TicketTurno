<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket de Turno</title>
    <link rel="stylesheet" href="ticket.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header class="header">
        <%- include('./partials/navbar') %>
    </header>
        
    <div class="container">
        
        
        <form class="form" id="ticket-form" method="POST" action="#">
            <div class="row">
                <div class="field-group full-width">
                    <label for="nombre-completo">Nombre completo de quien realizar√° el tr√°mite:</label>
                    <input type="text" id="nombre-completo" name="nombre-completo" required>
                </div>
                <div class="field-group small">
                    <label for="curp">CURP:</label>
                    <input type="text" id="curp" name="curp" maxlength="18" required>
                </div>
            </div>
            
            <div class="row">
                <div class="field-group">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div class="field-group">
                    <label for="paterno">Paterno:</label>
                    <input type="text" id="paterno" name="paterno" required>
                </div>
                <div class="field-group">
                    <label for="materno">Materno:</label>
                    <input type="text" id="materno" name="materno">
                </div>
            </div>
            
            <div class="row">
                <div class="field-group small">
                    <label for="telefono">Tel√©fono:</label>
                    <input type="tel" id="telefono" name="telefono">
                </div>
                <div class="field-group small">
                    <label for="celular">Celular:</label>
                    <input type="tel" id="celular" name="celular">
                </div>
                <div class="field-group small">
                    <label for="correo">Correo:</label>
                    <input type="email" id="correo" name="correo">
                </div>
            </div>
            
            <div class="row">
                <div class="field-group medium">
                    <label for="nivel">¬øNivel al que desea ingresar o que ya cursa el alumno?</label>
                    <select id="nivel" name="nivel" required>
                        <option value="" disabled selected>Seleccione Nivel</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="field-group medium">
                    <label for="municipio">Municipio donde desea estudie el alumno:</label>
                    <select id="municipio" name="municipio" required>
                        <option value="" disabled selected>Seleccione Municipio</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="field-group full-width">
                    <label for="asunto">Seleccione el asunto que va a tratar:</label>
                    <select id="asunto" name="asunto" required>
                        <option value="" disabled selected>Seleccione Asunto</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="field-group full-width" style="text-align: center;">
                    <p style="margin: 10px 0;">
                        ¬øYa tienes un turno? 
                        <a href="/modificar_turno" style="color: #007bff; text-decoration: none; font-weight: bold;">
                            Modificar mi solicitud
                        </a>
                    </p>
                </div>
            </div>
            
            <div class="button-container">
                <button type="submit" class="submit-btn" id="submit-btn">Generar Turno</button>
            </div>
        </form>
    </div>

    <!-- Script inline para debug -->
    <script>
        console.log('Script inline ejecut√°ndose...');
        console.log('Formulario encontrado:', document.getElementById('ticket-form'));
    </script>

    <!-- Script externo -->
    <script>
        // Todo el JavaScript INLINE aqu√≠
        document.addEventListener('DOMContentLoaded', function() {
    // Referencias a los elementos del formulario
    const form = document.getElementById('ticket-form');
    const nombreCompletoInput = document.getElementById('nombre-completo');
    const nombreInput = document.getElementById('nombre');
    const paternoInput = document.getElementById('paterno');
    const maternoInput = document.getElementById('materno');
    const curpInput = document.getElementById('curp');
    const nivelSelect = document.getElementById('nivel');
    const municipioSelect = document.getElementById('municipio');
    const asuntoSelect = document.getElementById('asunto');

    // Cargar datos de los combos al iniciar
    cargarNiveles();
    cargarMunicipios();
    cargarAsuntos();

    // Auto-completar nombre completo cuando cambian los campos individuales
    [nombreInput, paternoInput, maternoInput].forEach(input => {
        input.addEventListener('input', actualizarNombreCompleto);
    });

    // Validar CURP en tiempo real
    curpInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
        validarCURP(this.value);
    });

    // Manejar el env√≠o del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (validarFormulario()) {
            enviarSolicitud();
        }
    });

    // ==================== FUNCIONES ====================

    // Cargar niveles desde la API
    async function cargarNiveles() {
        try {
            const response = await fetch('/api/niveles');
            const niveles = await response.json();
            
            nivelSelect.innerHTML = '<option value="" disabled selected>Seleccione Nivel</option>';
            niveles.forEach(nivel => {
                const option = document.createElement('option');
                option.value = nivel.id_nivel;
                option.textContent = nivel.nombre_nivel;
                nivelSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar niveles:', error);
            mostrarError('No se pudieron cargar los niveles educativos');
        }
    }

    // Cargar municipios desde la API
    async function cargarMunicipios() {
        try {
            const response = await fetch('/api/municipios');
            const municipios = await response.json();
            
            municipioSelect.innerHTML = '<option value="" disabled selected>Seleccione Municipio</option>';
            municipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio.id_municipio;
                option.textContent = municipio.nombre_municipio;
                municipioSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar municipios:', error);
            mostrarError('No se pudieron cargar los municipios');
        }
    }

    // Cargar asuntos desde la API
    async function cargarAsuntos() {
        try {
            const response = await fetch('/api/asuntos');
            const asuntos = await response.json();
            
            asuntoSelect.innerHTML = '<option value="" disabled selected>Seleccione Asunto</option>';
            asuntos.forEach(asunto => {
                const option = document.createElement('option');
                option.value = asunto.id_asunto;
                option.textContent = asunto.nombre_asunto;
                asuntoSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar asuntos:', error);
            mostrarError('No se pudieron cargar los asuntos');
        }
    }

    // Actualizar nombre completo autom√°ticamente
    function actualizarNombreCompleto() {
        const nombre = nombreInput.value.trim();
        const paterno = paternoInput.value.trim();
        const materno = maternoInput.value.trim();
        
        const nombreCompleto = [nombre, paterno, materno]
            .filter(parte => parte.length > 0)
            .join(' ');
        
        nombreCompletoInput.value = nombreCompleto;
    }

    // Validar formato de CURP
    function validarCURP(curp) {
        const curpRegex = /^[A-Z]{4}[0-9]{6}[A-Z]{6}[0-9A-Z]{2}$/;
        
        if (curp.length === 18) {
            if (curpRegex.test(curp)) {
                curpInput.style.borderColor = '#28a745';
                return true;
            } else {
                curpInput.style.borderColor = '#dc3545';
                return false;
            }
        } else {
            curpInput.style.borderColor = '#ccc';
            return false;
        }
    }

    // Validar todo el formulario
    function validarFormulario() {
        let errores = [];

        // Validar nombre completo
        if (!nombreCompletoInput.value.trim()) {
            errores.push('El nombre completo es requerido');
        }

        // Validar nombre individual
        if (!nombreInput.value.trim()) {
            errores.push('El nombre es requerido');
        }

        // Validar apellido paterno
        if (!paternoInput.value.trim()) {
            errores.push('El apellido paterno es requerido');
        }

        // Validar CURP
        const curp = curpInput.value.trim();
        if (!curp) {
            errores.push('La CURP es requerida');
        } else if (!validarCURP(curp)) {
            errores.push('La CURP no tiene un formato v√°lido');
        }

        // Validar nivel
        if (!nivelSelect.value) {
            errores.push('Debe seleccionar un nivel educativo');
        }

        // Validar municipio
        if (!municipioSelect.value) {
            errores.push('Debe seleccionar un municipio');
        }

        // Validar asunto
        if (!asuntoSelect.value) {
            errores.push('Debe seleccionar un asunto');
        }

        // Validar correo si se proporciona
        const correo = document.getElementById('correo').value.trim();
        if (correo) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(correo)) {
                errores.push('El correo electr√≥nico no es v√°lido');
            }
        }

        // Mostrar errores si existen
        if (errores.length > 0) {
            mostrarError(errores.join('\n'));
            return false;
        }

        return true;
    }

    // Enviar solicitud al servidor
    async function enviarSolicitud() {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Procesando...';

        const datos = {
            alumno: {
                nombre_completo: nombreCompletoInput.value.trim(),
                nombre: nombreInput.value.trim(),
                paterno: paternoInput.value.trim(),
                materno: maternoInput.value.trim() || null,
                curp: curpInput.value.trim().toUpperCase(),
                telefono: document.getElementById('telefono').value.trim() || null,
                celular: document.getElementById('celular').value.trim() || null,
                correo: document.getElementById('correo').value.trim() || null,
                id_nivel: parseInt(nivelSelect.value),
                id_municipio: parseInt(municipioSelect.value)
            },
            turno: {
                id_asunto: parseInt(asuntoSelect.value)
            }
        };

        try {
            const response = await fetch('/api/turnos/public/solicitar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });

            const resultado = await response.json();

            if (response.ok) {
                mostrarExito(resultado);
            } else {
                mostrarError(resultado.error || 'Error al procesar la solicitud');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generar Turno';
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error de conexi√≥n. Por favor, intente nuevamente.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Generar Turno';
        }
    }

    function mostrarExito(resultado) {
        console.log('‚úÖ Resultado completo:', resultado); // Para debug
        
        // Mostrar alert con informaci√≥n del turno
        alert(
            `‚úÖ Turno generado exitosamente!\n\n` +
            `N√∫mero de turno: ${resultado.turno.numero_turno}\n` +
            `CURP: ${resultado.alumno.curp}\n\n` +
            `A continuaci√≥n se descargar√° su comprobante en PDF.`
        );
        
        // Verificar que existe la URL del PDF
        if (resultado.pdfUrl) {
            console.log('üìÑ URL del PDF:', resultado.pdfUrl);
            
            // M√âTODO 1: Abrir en nueva pesta√±a (recomendado para visualizar)
            const ventanaPDF = window.open(resultado.pdfUrl, '_blank');
            
            // Verificar si se bloque√≥ el popup
            if (!ventanaPDF || ventanaPDF.closed || typeof ventanaPDF.closed === 'undefined') {
                // Si el popup fue bloqueado, ofrecer descarga directa
                console.warn('‚ö†Ô∏è Popup bloqueado, intentando descarga directa...');
                
                const descargar = confirm(
                    'El navegador bloque√≥ la ventana emergente.\n\n' +
                    '¬øDesea descargar el PDF directamente?'
                );
                
                if (descargar) {
                    descargarPDF(resultado.pdfUrl, resultado.turno.numero_turno);
                }
            }
            
            // M√âTODO 2: Tambi√©n crear un bot√≥n de descarga alternativo
            setTimeout(() => {
                const descargarAhora = confirm(
                    '¬øDesea tambi√©n descargar el PDF en su equipo?\n\n' +
                    '(Adem√°s de visualizarlo en el navegador)'
                );
                
                if (descargarAhora) {
                    descargarPDF(resultado.pdfUrl, resultado.turno.numero_turno);
                }
            }, 1000);
            
        } else {
            console.error('‚ùå No se encontr√≥ la URL del PDF en la respuesta');
            alert('El turno se gener√≥ correctamente, pero no se pudo generar el PDF. Contacte al administrador.');
        }
        
        // Limpiar formulario
        form.reset();
        nombreCompletoInput.value = '';
        
        // Recargar combos
        nivelSelect.innerHTML = '<option value="" disabled selected>Seleccione Nivel</option>';
        municipioSelect.innerHTML = '<option value="" disabled selected>Seleccione Municipio</option>';
        asuntoSelect.innerHTML = '<option value="" disabled selected>Seleccione Asunto</option>';
        
        cargarNiveles();
        cargarMunicipios();
        cargarAsuntos();

        // Rehabilitar bot√≥n
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generar Turno';
    }

    // Funci√≥n auxiliar para forzar la descarga del PDF
    function descargarPDF(url, numeroTurno) {
        const link = document.createElement('a');
        link.href = url;
        link.download = `ticket-${numeroTurno}.pdf`;
        link.target = '_blank';
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // Limpiar despu√©s de un momento
        setTimeout(() => {
            document.body.removeChild(link);
        }, 100);
    }

    // Mostrar mensaje de error
    function mostrarError(mensaje) {
        alert('‚ùå Error:\n\n' + mensaje);
    }
});
    
    </script>
    
    <!-- Verificaci√≥n de carga -->
    <!-- <script>
        window.addEventListener('load', function() {
            console.log('P√°gina completamente cargada');
            console.log('¬øticket.js cargado?', typeof cargarNiveles !== 'undefined');
        });
    </script> -->
</body>
</html>